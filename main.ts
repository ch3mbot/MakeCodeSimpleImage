let palBuf: Buffer = hex`0000002424247b68eeff93c4eee8aafff609249ca3ffffff003fad87f2ff8e2ec4a4839fdda0dde5cdc478dc52000000`
image.setPalette(palBuf)


function CreateImageNonBuffer(imagePieces: number[]) {
    let newImage = img`
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    `;
    let modIndex = 0;
    for (let i = 0; i < imagePieces.length; i++) {
        let entry = vidCopmressedV4Map.framePieceMap[imagePieces[i]]
        let col = entry > 16383 ? 7 : 0;
        let num = entry & 16383;
        for (let j = 0; j < num; j++) {
            newImage.setPixel(modIndex % 160, Math.floor(modIndex / 160), col);
            modIndex++;
        }
    }
    scene.setBackgroundImage(newImage);
}

function CreateImageBuffer(imagePieces: number[]) {

    let imageNumArray: number[] = [];
    for (let i = 0; i < imagePieces.length; i++) {
        let entry = vidCopmressedV4Map.framePieceMap[imagePieces[i]]
        let col = entry > 16383 ? 7 : 0;
        let num = entry & 16383;
        for (let j = 0; j < num; j++) {
            imageNumArray.push(col);
        }
    }

    let getPixel = (x: number, y: number): number => {
        return imageNumArray[y * 160 + x];
    }

    let imgHex =  imageProcessing.f4EncodeImg(160, 120, 4, getPixel)
    scene.setBackgroundImage(image.ofBuffer(Buffer.fromHex(imgHex)));
}

function RunImageTimingTests() {
    pause(1);
    let startTime = game.runtime();
    for (let i = 0; i < 3288; i++) {
        CreateImageBuffer(vidCompressedV4Val.allFramePieces[i]);
        pause(1);
    }
    game.splash("buffer ver time taken: ", (game.runtime() - startTime - 3288) + "ms");
    
    pause(1);
    
    startTime = game.runtime();
    for (let i = 0; i < 3288; i++) {
        CreateImageNonBuffer(vidCompressedV4Val.allFramePieces[i]);
        pause(1);
    }
    game.splash("non-buffer ver time taken: ", (game.runtime() - startTime - 3288) + "ms");
    
}

// buffer was 38998ms, non-buffer was 14583ms
//RunImageTimingTests();

let msPerFrame = 1000/15; //input vid if 15 fps
let frameIndex = 0;

//consider changing to Update, runs at 30 fps
game.onUpdateInterval(msPerFrame, function () { 
    CreateImageNonBuffer(vidCompressedV4Val.allFramePieces[frameIndex]);
    frameIndex++;
});
